/*
 * sf-collection - v0.1.5
 * jQuery plugin to handle symfony2 collection in a proper way
 * 
 *
 * Copyright (C) 2015  Giorgio Premi
 * Licensed under MIT License
 * See LICENSE file for the full copyright notice.
 */
!function(a){"use strict";function b(b,c){this.element=a(b),this.options=a.extend({},j,this.element.data(),c),this._defaults=j,this._name=i,this.widgetEventPrefix=i,this.entries=a(),this.entryNames=[],this.onRemoveAll=!1,this.lastEntry=null,this.init()}function c(a){return a.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")}function d(a){return"object"==typeof a&&null!==a&&a.length>0}function e(a,b){var d=a.find(':input[name^="'+b+'["]').eq(0),e=""+d.attr("name"),f=new RegExp("^"+c(b)+"\\[([a-z0-9]+)\\].*$"),g=e.match(f);return g?g[1]:null}function f(b,c){var d=b.data("prototype-remove")||'<a href="#remove">[-]</a>',e=a(a.trim(d));return e.length>1&&(console.warn("jquery.sf-collection.js: button should be a single DOM node. Wrapping everything in a div..."),e=a("<div>").append(e)),e.appendTo(c)}function g(b,c){if(c)return!1;var d=b.data("prototype-add")||'<a href="#add">[+]</a>',e=a(a.trim(d));return e.length>1&&(console.warn("jquery.sf-collection.js: button should be a single DOM node. Wrapping everything in a div..."),e=a("<div>").append(e)),e.appendTo(c?c:b)}function h(a,b){var c=a.data("sf-collection-max-entry")||Math.max.apply(null,b.concat(0));return isNaN(c)||!isFinite(c)?(console.error("jquery.sf-collection.js: cannot calculate a maximum. Define a custom entry name generator."),null):(a.data("sf-collection-max-entry",++c),c)}var i="sfcollection",j={collectionName:null,prototype:null,prototypeName:"__name__",allowAdd:!0,allowRemove:!0,initAddButton:g,initRemoveButton:f,entrySelector:"> div",entryNameGenerator:h,create:null,add:null,remove:null};a.extend(b.prototype,{init:function(){var b=this,c=this.options;if(c.collectionName=c.collectionName||"",!this.options.collectionName.length)return void console.error("jquery.sf-collection.js: collectionName is required to correctly ");if(this.element.addClass("sf-collection"),this.element.find(this.options.entrySelector).each(function(d,f){f=a(f);var g=e(f,c.collectionName);g&&(b._initEntryNode.call(b,f,g),b.lastEntry=f)}),c.allowAdd){var f=c.initAddButton(this.element);if(f!==!1){if(!d(f))return console.error("jquery.sf-collection.js: initAddButton must return a non-empty jQuery object or false"),!1;f.addClass("sf-collection-action sf-collection-add")}}if(c.allowRemove){var g=c.initRemoveButton(this.element);if(!1!==g){if(!d(g))return console.error("jquery.sf-collection.js: initRemoveButton must return a non-empty jQuery object or false"),!1;g.addClass("sf-collection-action sf-collection-remove")}}this.element.on("click",".sf-collection-action",function(a){b._dispatchClickEvent.call(b,a)}),this._trigger("create",null,{collection:this.element,entries:this.entries,entryNames:this.entryNames})},_initEntryNode:function(a,b){var c=this.options;if(this.entryNames.indexOf(b)>=0&&console.warn("jquery.sf-collection.js: duplicated entry name"),this.entries=this.entries.add(a),this.entryNames.push(b),a.addClass("sf-collection-entry").data("entry-name",b),c.allowAdd){var e=c.initAddButton(this.element,a);if(!1!==e){if(!d(f))return console.error("jquery.sf-collection.js: initAddButton must return a non-empty jQuery object or false"),!1;e.addClass("sf-collection-action sf-collection-add")}}if(c.allowRemove){var f=c.initRemoveButton(this.element,a);if(!1!==f){if(!d(f))return console.error("jquery.sf-collection.js: initRemoveButton must return a non-empty jQuery object or false"),!1;f.addClass("sf-collection-action sf-collection-remove")}}},_dispatchClickEvent:function(b){var c=a(b.currentTarget),d=a(b.target).closest(".sf-collection, .sf-collection-entry");if(d.is(".sf-collection")&&(d=null),c.is(".sf-collection-add"))this._addEntryNode(d,b);else{if(!c.is(".sf-collection-remove"))return;null!==d?this._removeEntryNode(d,b):this._removeAll(b)}b.stopPropagation(),b.preventDefault()},_addEntryNode:function(b,d){var e=this.options.entryNameGenerator(this.element,this.entryNames);b=b||this.lastEntry;var f=new RegExp(c(this.options.prototypeName),"g"),g=this.options.prototype.replace(f,e),h=a(a.trim(g));this._initEntryNode(h,e),b?h.insertAfter(b):h.prependTo(this.element);var i=this.lastEntry?this.lastEntry.nextAll(".sf-collection-entry").last():this.element.children(".sf-collection-entry").last();i.length&&(this.lastEntry=i),this._trigger("add",d,{collection:this.element,entries:this.entries,entry:h,entryName:e})},_removeAll:function(a){var b=this;for(this.onRemoveAll=!0;this.entries.length;)b._removeEntryNode.call(b,this.entries.eq(0),a);this.onRemoveAll=!1},_removeEntryNode:function(a,b){var c=a.data("entry-name");this.lastEntry.is(a)&&(this.lastEntry=this.lastEntry.prev(".sf-collection-entry"),this.lastEntry.length||(this.lastEntry=null));var d=this.entryNames.indexOf(c);-1!==d&&this.entryNames.splice(d,1),this.entries=this.entries.not(a),a.remove(),this._trigger("remove",b,{collection:this.element,entries:this.entries,entryNames:this.entryNames,entry:a,entryName:c,removeAll:this.onRemoveAll})},_trigger:function(b,c,d){var e,f,g=this.options[b];if(d=d||{},c=a.Event(c),c.type=(b===this.widgetEventPrefix?b:this.widgetEventPrefix+b).toLowerCase(),c.target=this.element[0],f=c.originalEvent)for(e in f)e in c||(c[e]=f[e]);return this.element.trigger(c,d),!(a.isFunction(g)&&g.apply(this.element[0],[c].concat(d))===!1||c.isDefaultPrevented())}}),a.fn[i]=function(c){return this.each(function(){var d=a.data(this,"plugin-"+i);d||(d=a.data(this,"plugin-"+i,new b(this,c)))})}}(jQuery,window,document);